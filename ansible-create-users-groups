# Create the playbook for creating groups and users on the target nodes
# $ vi add_users.yaml
---
- hosts: stapp02
  become: yes
  vars_files:
  - /home/thor/playbooks/data/users.yml
  - /home/thor/playbooks/data/password.yml
  tasks:
  - name: Create groups on app server 3
    group:
      name: "{{ item }}"
      state: present
    loop:
    - admins
    - developers

  - name: Create users of admins group on app server 3
    user:
      name: "{{ item }}"
      create_home: yes
      groups: admins,wheel
      append: yes
      password: "{{ admins_pwd | string | password_hash('sha512') }}"
    loop: "{{ admins }}"

  - name: Create users of developers group on app server 3
    user:
      name: "{{ item }}"
      create_home: no
      home: /var/www
      groups: developers
      append: yes
      password: "{{ devels_pwd | string | password_hash('sha512') }}"
    loop: "{{ developers }}"

# Save the exit the file

# Update the ansible.cfg file in /home/thor/playbooks directory with the following parameter
# $ vi ~/playbooks/ansible.cfg
vault_password_file = /home/thor/playbooks/secrets/vault.txt

# Save and exit the file

# Execute the ansible-vault command to generate the encrypted passwords for the admin and developer users
# $ ansible-vault encrypt_string --vault-password-file ~/playbooks/secrets/vault.txt 'ksH85UJjhb' --name 'devels_pwd'
# $ ansible-vault encrypt_string --vault-password-file ~/playbooks/secrets/vault.txt 'Rc5C9EyvbU' --name 'admins_pwd'

# Execute the command to run the playbook
# $ cd ~/ansible
# $ ansible-playbook -i inventory add_users.yml